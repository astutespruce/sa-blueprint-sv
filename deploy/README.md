# Install directly on Ubuntu 18.04

Install deps

```
sudo apt-get update && sudo apt-get install -y curl g++ git unzip libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev \
  libcairo2-dev libgles2-mesa-dev libgbm-dev libllvm3.9 libprotobuf-dev libxxf86vm-dev xvfb x11-utils
```

Note: the deps on line 2 are for mbgl-renderer.

Allocate 2 GB SWAP (more on larger volume):

```
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

Add this to `/etc/fstab`: `/swapfile none swap sw 0 0`

### Workspace

Everything happens in the `~/app` workspace:

```
mkdir ~/app
cd ~/app
```

Clone `sa-blueprint-sv` (this repo) into `~/app/sa-blueprint-sv`.

Create directories within that folder:

- tiles
- data

#### Install docker

https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-18-04

```
apt install -y apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
apt install -y docker-ce
usermod -aG docker ${USER}
```

log out and log back in.

### Inputs

Copy contents of local `tiles` directory to `~/app/sa-blueprint-sv/tiles`.

Copy `inputs` and `results` directories to `~/app/sa-blueprint-sv/data`.

### Build UI

TODO: this needs more info here

Create directory `ui/published` if it does not exist.

In `ui` directory:

- `npm run deploy`

### API

For local development, `pipenv` is used to manage dependencies. For deployment,
`requirements.txt` is used. This is generated by

```bash
pip freeze > requirements_raw.txt
```

Then editing by hand to add deployment specific libraries (e.g., `gunicorn`) and remove
dev specific dependencies.

Make sure to review this periodically to match versions used in development
(use the `[packages]` list in `Pipfile` as reference).

NOTE: `rasterio`, `fiona`, `shapely`, and `pygeos` must be installed using `--no-binary` option in order to use GDAL and GEOS within the docker container (avoids version
conflicts).

#### Docker container development notes

##### API / Worker

The API and worker share the same docker image for convenience (mostly overlapping dependencies).
They share a volume mounted at `/tmp/sa-reports` for exchanging user-uploaded files.

To ensure that the dependencies are correctly setup, run:

```bash
python tests/test_maps.py
```

(`renderer` container must be running)

If successful, this should produce images in `/tmp/aoi/*`

Watch for errors about not being able to connect to `renderer`.

Next run:

```bash
python tests/test_report.py
```

Then test that `uvicorn` starts correctly:

```bash
uvicorn api.api:app --port 5000
```

If it fails, it may raise messages about missing libraries (e.g., `cairo`).

Then test that `gunicorn` starts correctly:

```bash
gunicorn -k uvicorn.workers.UvicornWorker --name uvicorn api.api:app
```

Then test that `arq` starts correctly (depends on `redis` running):

```bash
arq api.worker.WorkerSettings
```
