# South Atlantic Simple Viewer Deployment

Note: the staging server is shared with `southeast-blueprint` project; see `deploy/shared` for that config in addition to details below.

### Next time

Create an T3.tiny EC2 instance with 100GB volume.

### Temporary: add more space

Create and attach 25 GB volume.

```
sudo mkfs -t ext4 /dev/xvdf
sudo mkdir /data
sudo chown -R ubuntu:ubuntu /data
sudo mount /dev/xvdf /data/
```

Add to `/etc/fstab`:

```
/dev/xvdf       /data   ext4    defaults,nofail
```

### Allocate swap space

Allocate 4 GB SWAP:

```
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

Add this to `/etc/fstab`: `/swapfile none swap sw 0 0`

## Docker

Install docker according to [docs](https://docs.docker.com/engine/install/ubuntu).

Add current user to docker group:

```
sudo usermod -aG docker $USER
```

Logout then log back in.

Install docker-compose according to [docs](https://docs.docker.com/compose/install/#install-compose-on-linux-systems).

## Workspace

see `shared/README.md`

## User interface

The user interface is built as a static website using GatsbyJS.

### Temporary

TODO: use NodeJS 12

#### Install nodejs 10

```
cd ~
curl -sL https://deb.nodesource.com/setup_10.x -o nodesource_setup.sh
sudo chmod 777 nodesource_setup.sh && sudo ./nodesource_setup.sh
sudo apt-get install -y nodejs
```

In `ui` directory:

- `sudo npm install -g gatsby-cli`
- `npm ci`
- `npm run deploy`

### Long term

TODO: replace with docker version of build UI

## API

For local development, `pipenv` is used to manage dependencies. For deployment,
`requirements.txt` is used. This is generated by

```bash
pip freeze > requirements_raw.txt
```

Then editing by hand to add deployment specific libraries (e.g., `gunicorn`) and remove
dev specific dependencies.

Make sure to review this periodically to match versions used in development
(use the `[packages]` list in `Pipfile` as reference).

NOTE: `rasterio`, `fiona`, `shapely`, and `pygeos` must be installed using `--no-binary` option in order to use GDAL and GEOS within the docker container (avoids version
conflicts).

NOTE: `pyogrio` is built after installing everything else. See `docker/api/Dockerfile`.

### API / background workder Docker container development notes

The API and worker share the same docker image for convenience (mostly overlapping dependencies).
They share a volume mounted at `/tmp/sa-reports` for exchanging user-uploaded files.

To ensure that the dependencies are correctly setup, run:

```bash
python tests/test_maps.py
```

(`renderer` container must be running)

If successful, this should produce images in `/tmp/aoi/*`

Watch for errors about not being able to connect to `renderer`.

Next run:

```bash
python tests/test_report.py
```

Then test that `uvicorn` starts correctly:

```bash
uvicorn api.api:app --port 5000
```

If it fails, it may raise messages about missing libraries (e.g., `cairo`).

Then test that `gunicorn` starts correctly:

```bash
gunicorn -k uvicorn.workers.UvicornWorker --name uvicorn api.api:app
```

Then test that `arq` starts correctly (depends on `redis` running):

```bash
arq api.worker.WorkerSettings
```
